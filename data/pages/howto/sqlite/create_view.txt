---json
{
    "page_id": "o3xebattvtoblu88ies4q"
}
---
====== How to create a SQL View with a SELECT query ======


===== About =====

This ''howto'' shows you how to create a [[:docs:resource:view|sql view]] with a [[:docs:resource:select|select query]] stored in [[:docs:resource:sql|SQL file]]

===== The Select Query =====

We are going to use the [[:docs:connection:tpcds_query|tpcds]] ''query_11.sql'' to create this view.

<unit>
<code bash>
tabli data print --type text sqlite/query_11.sql@tpcds_query
</code>
<console sql height="300px" scroll="toggle">
with year_total as (                                                                                                        
 select c_customer_id customer_id                                                                                           
       ,c_first_name customer_first_name                                                                                    
       ,c_last_name customer_last_name                                                                                      
       ,c_preferred_cust_flag customer_preferred_cust_flag                                                                  
       ,c_birth_country customer_birth_country                                                                              
       ,c_login customer_login                                                                                              
       ,c_email_address customer_email_address                                                                              
       ,d_year dyear                                                                                                        
       ,sum(ss_ext_list_price-ss_ext_discount_amt) year_total                                                               
       ,'s' sale_type                                                                                                       
 from customer                                                                                                              
     ,store_sales                                                                                                           
     ,date_dim                                                                                                              
 where c_customer_sk = ss_customer_sk                                                                                       
   and ss_sold_date_sk = d_date_sk                                                                                          
 group by c_customer_id                                                                                                     
         ,c_first_name                                                                                                      
         ,c_last_name                                                                                                       
         ,c_preferred_cust_flag                                                                                             
         ,c_birth_country                                                                                                   
         ,c_login                                                                                                           
         ,c_email_address                                                                                                   
         ,d_year                                                                                                            
 union all                                                                                                                  
 select c_customer_id customer_id                                                                                           
       ,c_first_name customer_first_name                                                                                    
       ,c_last_name customer_last_name                                                                                      
       ,c_preferred_cust_flag customer_preferred_cust_flag                                                                  
       ,c_birth_country customer_birth_country                                                                              
       ,c_login customer_login                                                                                              
       ,c_email_address customer_email_address                                                                              
       ,d_year dyear                                                                                                        
       ,sum(ws_ext_list_price-ws_ext_discount_amt) year_total                                                               
       ,'w' sale_type                                                                                                       
 from customer                                                                                                              
     ,web_sales                                                                                                             
     ,date_dim                                                                                                              
 where c_customer_sk = ws_bill_customer_sk                                                                                  
   and ws_sold_date_sk = d_date_sk                                                                                          
 group by c_customer_id                                                                                                     
         ,c_first_name                                                                                                      
         ,c_last_name                                                                                                       
         ,c_preferred_cust_flag                                                                                             
         ,c_birth_country                                                                                                   
         ,c_login                                                                                                           
         ,c_email_address                                                                                                   
         ,d_year                                                                                                            
         )                                                                                                                  
  select                                                                                                                    
                  t_s_secyear.customer_id                                                                                   
                 ,t_s_secyear.customer_first_name                                                                           
                 ,t_s_secyear.customer_last_name                                                                            
                 ,t_s_secyear.customer_email_address                                                                        
 from year_total t_s_firstyear                                                                                              
     ,year_total t_s_secyear                                                                                                
     ,year_total t_w_firstyear                                                                                              
     ,year_total t_w_secyear                                                                                                
 where t_s_secyear.customer_id = t_s_firstyear.customer_id                                                                  
         and t_s_firstyear.customer_id = t_w_secyear.customer_id                                                            
         and t_s_firstyear.customer_id = t_w_firstyear.customer_id                                                          
         and t_s_firstyear.sale_type = 's'                                                                                  
         and t_w_firstyear.sale_type = 'w'                                                                                  
         and t_s_secyear.sale_type = 's'                                                                                    
         and t_w_secyear.sale_type = 'w'                                                                                    
         and t_s_firstyear.dyear = 2001                                                                                     
         and t_s_secyear.dyear = 2001+1                                                                                     
         and t_w_firstyear.dyear = 2001                                                                                     
         and t_w_secyear.dyear = 2001+1                                                                                     
         and t_s_firstyear.year_total > 0                                                                                   
         and t_w_firstyear.year_total > 0                                                                                   
         and case when t_w_firstyear.year_total > 0 then t_w_secyear.year_total / t_w_firstyear.year_total else 0.0 end     
             > case when t_s_firstyear.year_total > 0 then t_s_secyear.year_total / t_s_firstyear.year_total else 0.0 end   
 order by t_s_secyear.customer_id                                                                                           
         ,t_s_secyear.customer_first_name                                                                                   
         ,t_s_secyear.customer_last_name                                                                                    
         ,t_s_secyear.customer_email_address                                                                                
limit 100;\n\n
</console>
</unit>

===== The creation =====

<unit display="none">
Drop the view if it exists
<code bash>
tabli data drop --not-strict query_11@sqlite
</code>
</unit>

With the [[:docs:tabli:data:create|tabli create]] command, to create view called ''query_11'' from the ''query_11.sql'' file, you would execute the following command:
<unit>
<code bash>
tabli data create \
   --target-attribute type=view \
   sqlite/query_11.sql@tpcds_query  \
   @sqlite
</code>
where:
  * ''--target-attribute type=view'' specifies the [[:docs:resource:type|media type]] as [[:docs:resource:view|view]].
    * It means that we want to create a sql view and not a [[:docs:resource:table|sql table]] (the default, for the [[:docs:op:create|create operation]] in a relational system)
  * ''sqlite/query_11.sql@tpcds_query'' is a [[:docs:resource:data_selector|data selector]] that selects the ''query_11.sql'' [[:docs:connection:tpcds_query|tpcds]] [[:docs:resource:sql|sql file]]  as [[:docs:flow:source|source]]
  * ''@sqlite'' select the [[:howto:sqlite:connection|sql howto connection]] as [[:docs:flow:target|target]]

Output:
<console>
source                            target            
-------------------------------   ---------------   
sqlite/query_11.sql@tpcds_query   query_11@sqlite
</console>
</unit>
