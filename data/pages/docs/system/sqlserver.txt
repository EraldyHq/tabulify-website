====== Sql Server ======



Tabulify supports [[https://learn.microsoft.com/en-us/sql/|Sql Server]] as [[[[:docs:flow:source|source]] and [[:docs:flow:target|target]].

===== How to start a local SqlServer ? =====

To use the [[:docs:connection:howtos|Howto sqlserver connection]], you can start a local SqlServer with the following docker command:

```bash
docker run \
    -e MSSQL_SA_PASSWORD=TheSecret1! \
    -e ACCEPT_EULA=Y \
    -p 1433:1433 \
    -d \
    --name sqlserver \
    mcr.microsoft.com/mssql/server:2022-CU18-ubuntu-22.04
```


===== Note =====

==== Varchar ====
''Tabulify'' modifies the default length for VARCHAR and NVARCHAR from ''1'' to ''max'' 

`max` is the default for most database and avoid many problem when the length is not defined (ie nobody wants to store `1` character in a `varchar`).

==== Upsert ====

SqlServer does not use the SQL standard ''insert on conflict'' statement but a  [[https://learn.microsoft.com/en-us/sql/t-sql/statements/merge-transact-sql|merge statement]].

This merge statement requires a ''ON'' condition. Tabulify sets it to the first unique key constraint and if none is found, a standard insert statement is used.



==== Date/Time Sql Type ====

We map:

  * the standard sql `timestamp` type to the [[https://learn.microsoft.com/en-us/sql/t-sql/data-types/datetime2-transact-sql?view=sql-server-ver16|datetime2]] sql server type
  * the standard sql `timestamp with timezone` type to the [[https://learn.microsoft.com/en-us/sql/t-sql/data-types/datetimeoffset-transact-sql|datetimeoffset]] sql server type

Because Sql Server does not support `time with time zone`, we translate it to the [[https://learn.microsoft.com/en-us/sql/t-sql/data-types/time-transact-sql|time]] sql server type when creating a table from a third database.

==== Unable to truncate a table with a foreign key ====

Sql Server does not support the [[docs:op:truncate|truncate]] operations on a table that has a foreign key even if the foreign table is empty.

You would get this kind of error:
```
Cannot truncate table 'master.dbo.d_date' because it is being referenced by a FOREIGN KEY constraint.
```
If you want to truncate, you need to [[:docs:op:drop|drop]] and [[docs:op:create|recreate]]